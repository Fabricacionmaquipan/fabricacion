<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Solicitudes Bodega-Fabricación</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        /* Estilos generales */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* Estilos para pantalla de login */
        #login-screen {
            max-width: 500px;
            margin: 100px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para los paneles */
        #bodega-panel, #fabricacion-panel, #admin-panel {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        }

        /* Estilos para formularios */
        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .card-header {
            background-color: #f1f5f9;
            font-weight: bold;
        }

        /* Estilos para tablas */
        .table-responsive {
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.03);
        }

        .table th {
            background-color: #f1f5f9;
            font-weight: 600;
        }

        /* Estilos para los items de productos */
        .item-row {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .item-row:last-child {
            border-bottom: none;
        }

        /* Estilos para historial de cambios */
        .history-item {
            border-left: 3px solid #0d6efd;
            padding-left: 10px;
            margin-bottom: 10px;
        }

        .history-date {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* Estilos para sincronización */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Sistema Solicitudes</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item" id="user-info" style="display: none;">
                        <span class="nav-link text-white">Usuario: <span id="user-role-display"></span></span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout-btn" style="display: none;">Cerrar Sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Pantalla de selección de rol -->
        <div id="login-screen" class="text-center">
            <h2>Bienvenido al Sistema de Solicitudes</h2>
            <p>Por favor selecciona un rol para continuar</p>
            
            <div class="card mx-auto">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="role-select" class="form-label">Selecciona tu rol:</label>
                        <select class="form-select" id="role-select">
                            <option value="">-- Seleccionar rol --</option>
                            <option value="bodega">Bodega</option>
                            <option value="fabricacion">Fabricación</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary w-100" id="login-button">Ingresar</button>
                </div>
            </div>
        </div>

        <!-- Panel de Bodega -->
        <div id="bodega-panel" style="display: none;">
            <h2>Panel de Bodega</h2>
            <div class="card mb-4">
                <div class="card-header">
                    Nueva Solicitud
                </div>
                <div class="card-body">
                    <form id="nueva-solicitud-form">
                        <div class="mb-3">
                            <label for="nota-venta" class="form-label">Nota de Venta</label>
                            <input type="text" class="form-control" id="nota-venta" required>
                        </div>
                        <div class="mb-3">
                            <label for="fecha-solicitud" class="form-label">Fecha de Solicitud</label>
                            <input type="date" class="form-control" id="fecha-solicitud" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Detalle de lo Solicitado</label>
                            <div id="items-container">
                                <div class="item-row">
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <input type="text" class="form-control" placeholder="Nombre del producto" name="producto[]" required>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <input type="number" class="form-control" placeholder="Cantidad" name="cantidad[]" required>
                                        </div>
                                        <div class="col-md-2 mb-2">
                                            <button type="button" class="btn btn-danger remove-item">Eliminar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary mt-2" id="add-item">Agregar Producto</button>
                        </div>
                        <button type="submit" class="btn btn-primary">Enviar Solicitud</button>
                    </form>
                </div>
            </div>
            
            <h3>Historial de Solicitudes</h3>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nota Venta</th>
                            <th>Fecha Solicitud</th>
                            <th>Estado</th>
                            <th>Detalle</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-solicitudes-bodega">
                        <!-- Se llenará con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Panel de Fabricación -->
        <div id="fabricacion-panel" style="display: none;">
            <h2>Panel de Fabricación</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nota Venta</th>
                            <th>Fecha Solicitud</th>
                            <th>Detalle</th>
                            <th>Estado</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-solicitudes-fabricacion">
                        <!-- Se llenará con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Panel de Admin -->
        <div id="admin-panel" style="display: none;">
            <h2>Panel de Administración</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nota Venta</th>
                            <th>Fecha Solicitud</th>
                            <th>Detalle</th>
                            <th>Estado</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-solicitudes-admin">
                        <!-- Se llenará con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modales para detalles y ediciones -->
    <div class="modal fade" id="detalle-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalle de Solicitud</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detalle-modal-body">
                    <!-- Se llenará con JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="actualizar-estado-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Actualizar Estado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="actualizar-estado-form">
                        <input type="hidden" id="solicitud-id">
                        <div class="mb-3">
                            <label for="nuevo-estado" class="form-label">Estado</label>
                            <select class="form-select" id="nuevo-estado" required>
                                <option value="Solicitud enviada por bodega">Solicitud enviada por bodega</option>
                                <option value="En fabricación">En fabricación</option>
                                <option value="Entregado">Entregado</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observaciones" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de sincronización -->
    <div class="sync-status" id="sync-status">
        <span id="sync-message">Sincronizando datos...</span>
    </div>

    <!-- Script de Bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script principal de la aplicación -->
    <script>
        // Datos de ejemplo para pruebas
        const solicitudesData = [
            {
                id: '1683456789012',
                notaVenta: 'NV-2023-001',
                fechaSolicitud: '2023-05-07',
                estado: 'Solicitud enviada por bodega',
                observaciones: '',
                items: [
                    { producto: 'Mesa de centro', cantidad: 2 },
                    { producto: 'Silla de comedor', cantidad: 8 }
                ],
                historial: [
                    {
                        fecha: '2023-05-07T10:30:00Z',
                        estado: 'Solicitud enviada por bodega',
                        observaciones: '',
                        usuario: 'usuario_bodega'
                    }
                ]
            },
            {
                id: '1683556789012',
                notaVenta: 'NV-2023-002',
                fechaSolicitud: '2023-05-08',
                estado: 'En fabricación',
                observaciones: 'Pendiente por falta de material',
                items: [
                    { producto: 'Estantería', cantidad: 1 },
                    { producto: 'Escritorio', cantidad: 1 }
                ],
                historial: [
                    {
                        fecha: '2023-05-08T09:15:00Z',
                        estado: 'Solicitud enviada por bodega',
                        observaciones: '',
                        usuario: 'usuario_bodega'
                    },
                    {
                        fecha: '2023-05-09T11:20:00Z',
                        estado: 'En fabricación',
                        observaciones: 'Pendiente por falta de material',
                        usuario: 'usuario_fabricacion'
                    }
                ]
            },
            {
                id: '1683656789012',
                notaVenta: 'NV-2023-003',
                fechaSolicitud: '2023-05-09',
                estado: 'Entregado',
                observaciones: 'Entregado completo',
                items: [
                    { producto: 'Cama king', cantidad: 1 }
                ],
                historial: [
                    {
                        fecha: '2023-05-09T08:45:00Z',
                        estado: 'Solicitud enviada por bodega',
                        observaciones: '',
                        usuario: 'usuario_bodega'
                    },
                    {
                        fecha: '2023-05-10T10:30:00Z',
                        estado: 'En fabricación',
                        observaciones: '',
                        usuario: 'usuario_fabricacion'
                    },
                    {
                        fecha: '2023-05-12T14:20:00Z',
                        estado: 'Entregado',
                        observaciones: 'Entregado completo',
                        usuario: 'usuario_fabricacion'
                    }
                ]
            }
        ];

        // Variables globales
        let currentRole = '';
        let solicitudes = [...solicitudesData]; // Inicializar con datos de ejemplo
        let syncInterval = null;
        const syncStatus = document.getElementById('sync-status');
        const syncMessage = document.getElementById('sync-message');

        // Elementos DOM
        const loginScreen = document.getElementById('login-screen');
        const bodegaPanel = document.getElementById('bodega-panel');
        const fabricacionPanel = document.getElementById('fabricacion-panel');
        const adminPanel = document.getElementById('admin-panel');
        const roleSelect = document.getElementById('role-select');
        const loginButton = document.getElementById('login-button');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const userRoleDisplay = document.getElementById('user-role-display');
        
        // Elementos de Bodega
        const nuevaSolicitudForm = document.getElementById('nueva-solicitud-form');
        const itemsContainer = document.getElementById('items-container');
        const addItemBtn = document.getElementById('add-item');
        const tablaSolicitudesBodega = document.getElementById('tabla-solicitudes-bodega');
        
        // Elementos de Fabricación y Admin
        const tablaSolicitudesFabricacion = document.getElementById('tabla-solicitudes-fabricacion');
        const tablaSolicitudesAdmin = document.getElementById('tabla-solicitudes-admin');
        
        // Elementos para modales
        const detalleModal = document.getElementById('detalle-modal');
        const detalleModalBody = document.getElementById('detalle-modal-body');
        const actualizarEstadoModal = document.getElementById('actualizar-estado-modal');
        const actualizarEstadoForm = document.getElementById('actualizar-estado-form');
        const solicitudIdInput = document.getElementById('solicitud-id');
        const nuevoEstadoSelect = document.getElementById('nuevo-estado');
        const observacionesText = document.getElementById('observaciones');

        // Inicializar la aplicación cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar la aplicación
            init();
        });

        // Función de inicialización
        async function init() {
            console.log('Iniciando aplicación...');
            
            // Comprobar si hay un rol guardado en localStorage
            const savedRole = localStorage.getItem('current_role');
            
            // Cargar solicitudes desde el localStorage
            const savedData = localStorage.getItem('solicitudes');
            if (savedData) {
                try {
                    solicitudes = JSON.parse(savedData);
                } catch (error) {
                    console.error('Error al cargar datos guardados:', error);
                }
            }
            
            // Mostrar el panel correspondiente según el rol guardado
            if (savedRole) {
                currentRole = savedRole;
                showPanel(currentRole);
            } else {
                showLoginScreen();
            }
            
            // Configurar event listeners
            setupEventListeners();
        }

        // Configurar los escuchadores de eventos
        function setupEventListeners() {
            // Evento de inicio de sesión
            loginButton.addEventListener('click', () => {
                const selectedRole = roleSelect.value;
                if (selectedRole) {
                    currentRole = selectedRole;
                    localStorage.setItem('current_role', currentRole);
                    showPanel(currentRole);
                } else {
                    alert('Por favor, selecciona un rol para continuar.');
                }
            });
            
            // Evento de cierre de sesión
            logoutBtn.addEventListener('click', () => {
                currentRole = '';
                localStorage.removeItem('current_role');
                showLoginScreen();
            });
            
            // Eventos para el panel de Bodega
            if (nuevaSolicitudForm) {
                nuevaSolicitudForm.addEventListener('submit', handleNuevaSolicitud);
            }
            
            if (addItemBtn) {
                addItemBtn.addEventListener('click', addItem);
            }
            
            // Evento para eliminar un item
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-item')) {
                    removeItem(e.target);
                }
                
                // Evento para mostrar detalle
                if (e.target.classList.contains('btn-detalle')) {
                    const solicitudId = e.target.getAttribute('data-id');
                    showDetalleSolicitud(solicitudId);
                }
                
                // Evento para cambiar estado
                if (e.target.classList.contains('btn-cambiar-estado')) {
                    const solicitudId = e.target.getAttribute('data-id');
                    showActualizarEstadoModal(solicitudId);
                }
            });
            
            // Evento para actualizar estado
            if (actualizarEstadoForm) {
                actualizarEstadoForm.addEventListener('submit', handleActualizarEstado);
            }
        }

        // Mostrar la pantalla de inicio de sesión
        function showLoginScreen() {
            loginScreen.style.display = 'block';
            bodegaPanel.style.display = 'none';
            fabricacionPanel.style.display = 'none';
            adminPanel.style.display = 'none';
            logoutBtn.style.display = 'none';
            userInfo.style.display = 'none';
        }

        // Mostrar el panel según el rol seleccionado
        function showPanel(role) {
            loginScreen.style.display = 'none';
            logoutBtn.style.display = 'block';
            userInfo.style.display = 'block';
            
            // Mostrar el nombre del rol
            let roleName = '';
            switch (role) {
                case 'bodega': roleName = 'Bodega'; break;
                case 'fabricacion': roleName = 'Fabricación'; break;
                case 'admin': roleName = 'Administrador'; break;
            }
            userRoleDisplay.textContent = roleName;
            
            // Mostrar el panel correspondiente
            switch (role) {
                case 'bodega':
                    bodegaPanel.style.display = 'block';
                    fabricacionPanel.style.display = 'none';
                    adminPanel.style.display = 'none';
                    cargarDatosBodega();
                    break;
                case 'fabricacion':
                    bodegaPanel.style.display = 'none';
                    fabricacionPanel.style.display = 'block';
                    adminPanel.style.display = 'none';
                    cargarDatosFabricacion();
                    break;
                case 'admin':
                    bodegaPanel.style.display = 'none';
                    fabricacionPanel.style.display = 'none';
                    adminPanel.style.display = 'block';
                    cargarDatosAdmin();
                    break;
            }
        }

        // Cargar datos para el panel de Bodega
        function cargarDatosBodega() {
            if (!tablaSolicitudesBodega) return;
            
            tablaSolicitudesBodega.innerHTML = '';
            
            solicitudes.forEach(solicitud => {
                const tr = document.createElement('tr');
                
                // Determinar clase según el estado
                if (solicitud.estado === 'Entregado') {
                    tr.classList.add('table-success');
                } else if (solicitud.estado === 'En fabricación') {
                    tr.classList.add('table-warning');
                }
                
                tr.innerHTML = `
                    <td>${solicitud.id.substring(solicitud.id.length - 6)}</td>
                    <td>${solicitud.notaVenta}</td>
                    <td>${formatDate(solicitud.fechaSolicitud)}</td>
                    <td><span class="badge ${getStatusBadgeClass(solicitud.estado)}">${solicitud.estado}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info btn-detalle" data-id="${solicitud.id}">Ver Detalle</button>
                    </td>
                `;
                
                tablaSolicitudesBodega.appendChild(tr);
            });
        }

        // Cargar datos para el panel de Fabricación
        function cargarDatosFabricacion() {
            if (!tablaSolicitudesFabricacion) return;
            
            tablaSolicitudesFabricacion.innerHTML = '';
            
            solicitudes.forEach(solicitud => {
                const tr = document.createElement('tr');
                
                // Determinar clase según el estado
                if (solicitud.estado === 'Entregado') {
                    tr.classList.add('table-success');
                } else if (solicitud.estado === 'En fabricación') {
                    tr.classList.add('table-warning');
                }
                
                // Crear el detalle de productos
                const detalleProductos = solicitud.items.map(item => 
                    `${item.producto}: ${item.cantidad}`
                ).join('<br>');
                
                tr.innerHTML = `
                    <td>${solicitud.id.substring(solicitud.id.length - 6)}</td>
                    <td>${solicitud.notaVenta}</td>
                    <td>${formatDate(solicitud.fechaSolicitud)}</td>
                    <td>${detalleProductos}</td>
                    <td><span class="badge ${getStatusBadgeClass(solicitud.estado)}">${solicitud.estado}</span></td>
                    <td>${solicitud.observaciones || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info mb-1 btn-detalle" data-id="${solicitud.id}">
                            Ver
                        </button>
                        ${solicitud.estado !== 'Entregado' ? `
                            <button class="btn btn-sm btn-warning mb-1 btn-cambiar-estado" data-id="${solicitud.id}">
                                Cambiar Estado
                            </button>
                        ` : ''}
                    </td>
                `;
                
                tablaSolicitudesFabricacion.appendChild(tr);
            });
        }

        // Cargar datos para el panel de Admin
        function cargarDatosAdmin() {
            if (!tablaSolicitudesAdmin) return;
            
            tablaSolicitudesAdmin.innerHTML = '';
            
            solicitudes.forEach(solicitud => {
                const tr = document.createElement('tr');
                
                // Determinar clase según el estado
                if (solicitud.estado === 'Entregado') {
                    tr.classList.add('table-success');
                } else if (solicitud.estado === 'En fabricación') {
                    tr.classList.add('table-warning');
                }
                
                // Crear el detalle de productos
                const detalleProductos = solicitud.items.map(item => 
                    `${item.producto}: ${item.cantidad}`
                ).join('<br>');
                
                tr.innerHTML = `
                    <td>${solicitud.id.substring(solicitud.id.length - 6)}</td>
                    <td>${solicitud.notaVenta}</td>
                    <td>${formatDate(solicitud.fechaSolicitud)}</td>
                    <td>${detalleProductos}</td>
                    <td><span class="badge ${getStatusBadgeClass(solicitud.estado)}">${solicitud.estado}</span></td>
                    <td>${solicitud.observaciones || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info mb-1 btn-detalle" data-id="${solicitud.id}">
                            Ver
                        </button>
                        <button class="btn btn-sm btn-warning mb-1 btn-cambiar-estado" data-id="${solicitud.id}">
                            Editar
                        </button>
                    </td>
                `;
                
                tablaSolicitudesAdmin.appendChild(tr);
            });
        }

        // Manejar el envío del formulario de nueva solicitud
        async function handleNuevaSolicitud(e) {
            e.preventDefault();
            
            const notaVenta = document.getElementById('nota-venta').value;
            const fechaSolicitud = document.getElementById('fecha-solicitud').value;
            
            // Obtener productos y cantidades
            const productos = [];
            const cantidades = [];
            
            const productosInputs = document.querySelectorAll('input[name="producto[]"]');
            const cantidadesInputs = document.querySelectorAll('input[name="cantidad[]"]');
            
            for (let i = 0; i < productosInputs.length; i++) {
                const producto = productosInputs[i].value.trim();
                const cantidad = parseInt(cantidadesInputs[i].value);
                
                if (producto && !isNaN(cantidad) && cantidad > 0) {
                    productos.push(producto);
                    cantidades.push(cantidad);
                }
            }
            
            if (productos.length === 0) {
                alert('Debe agregar al menos un producto.');
                return;
            }
            
            // Crear la nueva solicitud
            const nuevaSolicitud = {
                id: Date.now().toString(),
                notaVenta: notaVenta,
                fechaSolicitud: fechaSolicitud,
                estado: 'Solicitud enviada por bodega',
                observaciones: '',
                items: [],
                historial: [
                    {
                        fecha: new Date().toISOString(),
                        estado: 'Solicitud enviada por bodega',
                        observaciones: '',
                        usuario: 'usuario_bodega'
                    }
                ]
            };
            
            // Agregar los productos
            for (let i = 0; i < productos.length; i++) {
                nuevaSolicitud.items.push({
                    producto: productos[i],
                    cantidad: cantidades[i]
                });
            }
            
            // Agregar la solicitud a la lista
            solicitudes.unshift(nuevaSolicitud);
            
            // Guardar en localStorage
            localStorage.setItem('solicitudes', JSON.stringify(solicitudes));
            
            // Limpiar el formulario
            nuevaSolicitudForm.reset();
            
            // Limpiar los items excepto el primero
            const items = document.querySelectorAll('.item-row');
            for (let i = 1; i < items.length; i++) {
                items[i].remove();
            }
            
            // Recargar los datos
            cargarDatosBodega();
            
            alert('Solicitud creada correctamente.');
        }

        // Agregar un nuevo item al formulario
        function addItem() {
            const newRow = document.createElement('div');
            newRow.className = 'item-row';
            newRow.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <input type="text" class="form-control" placeholder="Nombre del producto" name="producto[]" required>
                    </div>
                    <div class="col-md-4 mb-2">
                        <input type="number" class="form-control" placeholder="Cantidad" name="cantidad[]" required>
                    </div>
                    <div class="col-md-2 mb-2">
                        <button type="button" class="btn btn-danger remove-item">Eliminar</button>
                    </div>
                </div>
            `;
            
            itemsContainer.appendChild(newRow);
        }

        // Eliminar un item del formulario
        function removeItem(button) {
            const row = button.closest('.item-row');
            
            // No eliminar si es el único item
            const items = document.querySelectorAll('.item-row');
            if (items.length > 1) {
                row.remove();
            } else {
                alert('Debe haber al menos un producto.');
            }
        }

        // Manejar la actualización de estado
        async function handleActualizarEstado(e) {
            e.preventDefault();
            
            const solicitudId = solicitudIdInput.value;
            const nuevoEstado = nuevoEstadoSelect.value;
            const observaciones = observacionesText.value;
            
            const solicitud = solicitudes.find(s => s.id === solicitudId);
            
            if (solicitud) {
                const estadoAnterior = solicitud.estado;
                solicitud.estado = nuevoEstado;
                solicitud.observaciones = observaciones;
                
                // Agregar al historial
                solicitud.historial.push({
                    fecha: new Date().toISOString(),
                    estado: nuevoEstado,
                    observaciones: observaciones,
                    usuario: currentRole === 'admin' ? 'usuario_admin' : 'usuario_fabricacion'
                });
                
                // Guardar en localStorage
                localStorage.setItem('solicitudes', JSON.stringify(solicitudes));
                
                // Cerrar el modal
                const modal = bootstrap.Modal.getInstance(actualizarEstadoModal);
                modal.hide();
                
                // Recargar los datos
                if (currentRole === 'fabricacion') {
                    cargarDatosFabricacion();
                } else if (currentRole === 'admin') {
                    cargarDatosAdmin();
                }
                
                alert('Estado actualizado correctamente.');
            }
        }

        // Mostrar el detalle de una solicitud
        function showDetalleSolicitud(solicitudId) {
            const solicitud = solicitudes.find(s => s.id === solicitudId);
            
            if (solicitud) {
                // Llenar el modal con los detalles
                detalleModalBody.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>ID:</strong> ${solicitud.id}
                        </div>
                        <div class="col-md-6">
                            <strong>Nota de Venta:</strong> ${solicitud.notaVenta}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Fecha de Solicitud:</strong> ${formatDate(solicitud.fechaSolicitud)}
                        </div>
                        <div class="col-md-6">
                            <strong>Estado:</strong> 
                            <span class="badge ${getStatusBadgeClass(solicitud.estado)}">${solicitud.estado}</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <strong>Observaciones:</strong> 
                            <p>${solicitud.observaciones || 'Sin observaciones'}</p>
                        </div>
                    </div>
                    
                    <h5 class="mt-4">Productos Solicitados</h5>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${solicitud.items.map(item => `
                                <tr>
                                    <td>${item.producto}</td>
                                    <td>${item.cantidad}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h5 class="mt-4">Historial de Cambios</h5>
                    <div class="history-container">
                        ${solicitud.historial.map(hist => `
                            <div class="history-item">
                                <div class="history-date">${formatDateTime(hist.fecha)}</div>
                                <div><strong>Estado:</strong> ${hist.estado}</div>
                                ${hist.observaciones ? `<div><strong>Observaciones:</strong> ${hist.observaciones}</div>` : ''}
                                <div><strong>Usuario:</strong> ${hist.usuario}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Mostrar el modal
                const modal = new bootstrap.Modal(detalleModal);
                modal.show();
            } else {
                alert('No se encontró la solicitud.');
            }
        }

        // Mostrar el modal para actualizar estado
        function showActualizarEstadoModal(solicitudId) {
            const solicitud = solicitudes.find(s => s.id === solicitudId);
            
            if (solicitud) {
                solicitudIdInput.value = solicitudId;
                
                // Establecer el estado actual
                for (let i = 0; i < nuevoEstadoSelect.options.length; i++) {
                    if (nuevoEstadoSelect.options[i].value === solicitud.estado) {
                        nuevoEstadoSelect.selectedIndex = i;
                        break;
                    }
                }
                
                observacionesText.value = solicitud.observaciones || '';
                
                // Mostrar el modal
                const modal = new bootstrap.Modal(actualizarEstadoModal);
                modal.show();
            } else {
                alert('No se encontró la solicitud.');
            }
        }

        // Obtener clase para la insignia según el estado
        function getStatusBadgeClass(estado) {
            switch (estado) {
                case 'Solicitud enviada por bodega':
                    return 'bg-primary';
                case 'En fabricación':
                    return 'bg-warning text-dark';
                case 'Entregado':
                    return 'bg-success';
                default:
                    return 'bg-secondary';
            }
        }

        // Formatear fecha (YYYY-MM-DD a DD/MM/YYYY)
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const parts = dateString.split('-');
            if (parts.length !== 3) return dateString;
            
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        // Formatear fecha y hora
        function formatDateTime(isoString) {
            if (!isoString) return '';
            
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return isoString;
            
            return date.toLocaleString();
        }

        // Función para exportar datos a un archivo JSON
        function exportarDatos() {
            const dataStr = JSON.stringify(solicitudes, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const dataUrl = URL.createObjectURL(dataBlob);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = dataUrl;
            downloadLink.download = `solicitudes_${new Date().toISOString().substr(0, 10)}.json`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // Función para importar datos desde un archivo JSON
        function importarDatos(file) {
            const reader = new FileReader();
            
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    if (Array.isArray(importedData)) {
                        solicitudes = importedData;
                        localStorage.setItem('solicitudes', JSON.stringify(solicitudes));
                        
                        // Actualizar la vista según el rol actual
                        if (currentRole === 'bodega') {
                            cargarDatosBodega();
                        } else if (currentRole === 'fabricacion') {
                            cargarDatosFabricacion();
                        } else if (currentRole === 'admin') {
                            cargarDatosAdmin();
                        }
                        
                        alert('Datos importados correctamente.');
                    } else {
                        alert('El archivo no contiene un formato válido.');
                    }
                } catch (error) {
                    console.error('Error al importar datos:', error);
                    alert('Error al procesar el archivo.');
                }
            };
            
            reader.readAsText(file);
        }

        // Compartir datos entre sesiones
        window.addEventListener('storage', (event) => {
            if (event.key === 'solicitudes' && event.newValue) {
                try {
                    solicitudes = JSON.parse(event.newValue);
                    
                    // Actualizar la vista según el rol actual
                    if (currentRole === 'bodega') {
                        cargarDatosBodega();
                    } else if (currentRole === 'fabricacion') {
                        cargarDatosFabricacion();
                    } else if (currentRole === 'admin') {
                        cargarDatosAdmin();
                    }
                } catch (error) {
                    console.error('Error al procesar cambios en localStorage:', error);
                }
            }
        });
    </script>
</body>
</html>
