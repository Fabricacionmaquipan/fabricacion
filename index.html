<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Solicitudes</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/estilos-dashboards.css">
    <link rel="stylesheet" href="css/repuestos-styles.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid px-lg-4">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fas fa-boxes me-2"></i>
                <span>Sistema de Solicitudes</span>
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item" id="user-info" style="display: none;">
                        <span class="nav-link">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="user-display-name"></span>
                            (<span id="user-role-display"></span>)
                        </span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="#" id="logout-btn" style="display: none;">
                            <i class="fas fa-sign-out-alt me-1"></i>
                            <span>Cerrar Sesión</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="content-wrapper">
        <div class="container py-4">
            <div id="login-screen" class="text-center">
                <div class="login-container">
                    <div class="login-header mb-4">
                        <div class="app-icon mb-3">
                            <i class="fas fa-cubes"></i>
                        </div>
                        <h2>Bienvenido</h2>
                        <p class="text-muted">Inicia sesión para continuar</p>
                    </div>
                    <div class="login-form">
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="username-input" class="form-label text-start d-block">Usuario</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control" id="username-input" placeholder="Ingresa tu usuario" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="password-input" class="form-label text-start d-block">Contraseña</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="password-input" placeholder="Ingresa tu contraseña" required>
                                    <button class="btn btn-outline-secondary toggle-password" type="button"><i class="fas fa-eye"></i></button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="role-select" class="form-label text-start d-block">Rol en el sistema</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                                    <select class="form-select" id="role-select" required>
                                        <option value="">-- Seleccionar rol --</option>
                                        <option value="bodega">Bodega</option>
                                        <option value="fabricacion">Fabricación</option>
                                        <option value="admin">Administrador</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="login-button">
                                Ingresar <i class="fas fa-sign-in-alt ms-1"></i>
                            </button>
                        </form>
                        <div class="mt-3 text-muted small">
                            <p class="mb-0">Credenciales de prueba:</p>
                            <div class="row text-start mt-2">
                                <div class="col-md-4 mb-2"><strong>Bodega:</strong><br>Usuario: bodega<br>Clave: Bodega2025</div>
                                <div class="col-md-4 mb-2"><strong>Fabricación:</strong><br>Usuario: fabricacion<br>Clave: Pelaoyjoel</div>
                                <div class="col-md-4 mb-2"><strong>Administrador:</strong><br>Usuario: admin<br>Clave: Mono1700..</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="bodega-panel" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                    <h2 class="panel-title mb-0"><i class="fas fa-warehouse me-2"></i>Panel de Bodega</h2>
                    <div class="d-flex gap-2 mt-2 mt-md-0">
                        <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#nueva-solicitud-container" aria-expanded="true" aria-controls="nueva-solicitud-container">
                            <i class="fas fa-plus-circle me-1"></i> Nueva Solicitud
                        </button>
                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#historial-bodega" aria-expanded="true" aria-controls="historial-bodega">
                            <i class="fas fa-list me-1"></i> Historial
                        </button>
                    </div>
                </div>
                <div class="collapse show" id="nueva-solicitud-container">
                    <div class="card card-form mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Nueva Solicitud</h5>
                        </div>
                        <div class="card-body">
                            <form id="nueva-solicitud-form">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="nota-venta" class="form-label">Nota de Venta</label>
                                        <input type="text" class="form-control" id="nota-venta" placeholder="Ingrese número de nota" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="fecha-solicitud" class="form-label">Fecha de Solicitud</label>
                                        <input type="date" class="form-control" id="fecha-solicitud" required readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="cliente" class="form-label">Cliente</label>
                                        <input type="text" class="form-control" id="cliente" placeholder="Nombre del cliente">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="local" class="form-label">Local</label>
                                        <input type="text" class="form-control" id="local" placeholder="Nombre del local">
                                    </div>
                                    <div class="col-12">
                                        <label for="observaciones-bodega" class="form-label">Observaciones (Opcional)</label>
                                        <textarea class="form-control" id="observaciones-bodega" rows="2" placeholder="Observaciones adicionales para esta solicitud..."></textarea>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">Productos solicitados</label>
                                        <button type="button" class="btn btn-sm btn-primary" id="add-item">
                                            <i class="fas fa-plus me-1"></i> Agregar Producto
                                        </button>
                                    </div>
                                    <div class="items-container" id="items-container">
                                        <div class="item-row mb-2">
                                            <div class="row g-2 align-items-center">
                                                <div class="col-md-3 col-sm-12 position-relative">
                                                    <label for="sku-item-0" class="form-label visually-hidden">SKU</label>
                                                    <input type="text" id="sku-item-0" class="form-control sku-input" placeholder="SKU (Opcional)" name="sku[]" autocomplete="off">
                                                    <div class="dropdown-menu producto-suggestions"></div>
                                                </div>
                                                <div class="col-md-4 col-sm-12 position-relative">
                                                     <label for="producto-item-0" class="form-label visually-hidden">Nombre del Producto</label>
                                                    <input type="text" id="producto-item-0" class="form-control producto-input" placeholder="Nombre del producto" name="producto[]" required autocomplete="off">
                                                    <div class="dropdown-menu producto-suggestions"></div>
                                                </div>
                                                <div class="col-md-3 col-sm-8">
                                                    <label for="cantidad-item-0" class="form-label visually-hidden">Cantidad</label>
                                                    <input type="number" id="cantidad-item-0" class="form-control" placeholder="Cantidad" name="cantidad[]" min="1" required>
                                                </div>
                                                <div class="col-md-2 col-sm-4 d-flex align-items-end">
                                                    <button type="button" class="btn btn-outline-danger w-100 remove-item" aria-label="Eliminar producto">
                                                        <i class="fas fa-trash-alt"></i> <span class="d-none d-md-inline">Eliminar</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-1"></i> Enviar Solicitud
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="historial-bodega">
                    <div class="card mb-4">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center flex-wrap">
                                <h5 class="mb-0 me-2"><i class="fas fa-history me-2"></i>Historial de Solicitudes</h5>
                                <div class="d-flex gap-2 mt-2 mt-md-0">
                                    <div class="dropdown">
                                        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-filter me-1"></i> Todas
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item active" href="#">Todas</a></li>
                                            <li><a class="dropdown-item" href="#">Pendientes</a></li>
                                            <li><a class="dropdown-item" href="#">En Fabricación</a></li>
                                            <li><a class="dropdown-item" href="#">Entregadas</a></li>
                                        </ul>
                                    </div>
                                    <div class="input-group input-group-sm" style="max-width: 200px;">
                                        <input type="text" class="form-control" placeholder="Buscar..." id="buscar-solicitud-bodega">
                                        <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th><th>Nota Venta</th><th>Cliente</th><th>Local</th>
                                        <th>Fecha Sol.</th><th>Fecha Est.</th><th>Fecha Ent.</th>
                                        <th>Estado</th><th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-solicitudes-bodega"></tbody>
                            </table>
                        </div>
                        <div class="card-footer p-2" id="bodega-pagination-controls"></div>
                    </div>
                </div>
            </div>

            <div id="fabricacion-panel" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                    <h2 class="panel-title mb-0 me-2"><i class="fas fa-industry me-2"></i>Panel de Fabricación</h2>
                    <div class="d-flex gap-2 mt-2 mt-md-0">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-filter me-1"></i> Todas
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item active" href="#">Todas</a></li>
                                <li><a class="dropdown-item" href="#">Pendientes</a></li>
                                <li><a class="dropdown-item" href="#">En Fabricación</a></li>
                                <li><a class="dropdown-item" href="#">Entregadas</a></li>
                            </ul>
                        </div>
                        <div class="input-group input-group-sm" style="max-width: 200px;">
                            <input type="text" class="form-control" id="buscar-solicitud-fabricacion" placeholder="Buscar...">
                            <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                   <th>ID</th><th>Nota Venta</th><th>Cliente</th><th>Local</th>
                                   <th>Fecha Sol.</th><th>Fecha Est.</th><th>Fecha Ent.</th>
                                   <th>Estado</th><th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-solicitudes-fabricacion"></tbody>
                        </table>
                    </div>
                    <div class="card-footer p-2" id="fabricacion-pagination-controls"></div>
                </div>
            </div>

            <div id="admin-panel" style="display: none;">
                <h2 class="panel-title mb-3"><i class="fas fa-user-shield me-2"></i>Panel de Administración</h2>
                <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" id="solicitudes-tab" data-bs-toggle="tab" data-bs-target="#solicitudes-content" type="button" role="tab"><i class="fas fa-list me-1"></i> Solicitudes</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="usuarios-tab" data-bs-toggle="tab" data-bs-target="#usuarios-content" type="button" role="tab"><i class="fas fa-users-cog me-1"></i> Usuarios</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="repuestos-tab" data-bs-toggle="tab" data-bs-target="#repuestos-content" type="button" role="tab"><i class="fas fa-tools me-1"></i> Repuestos</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-content" type="button" role="tab"><i class="fas fa-chart-line me-1"></i> Dashboard</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="reportes-tab" data-bs-toggle="tab" data-bs-target="#reportes-content" type="button" role="tab"><i class="fas fa-file-alt me-1"></i> Reportes</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="auditoria-tab" data-bs-toggle="tab" data-bs-target="#auditoria-content" type="button" role="tab"><i class="fas fa-history me-1"></i> Auditoría</button></li>
                </ul>
                <div class="tab-content" id="adminTabContent">
                    <div class="tab-pane fade show active" id="solicitudes-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                            <h5 class="mb-0 me-2">Gestión de Solicitudes</h5>
                            <div class="d-flex gap-2 mt-2 mt-md-0">
                                <button class="btn btn-outline-success btn-sm" id="btn-generar-estadisticas-admin"><i class="fas fa-chart-bar me-1"></i> Estadísticas</button>
                                <button class="btn btn-outline-info btn-sm" id="btn-exportar-solicitudes-admin"><i class="fas fa-file-export me-1"></i> Exportar</button>
                                <div class="dropdown">
                                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown"><i class="fas fa-filter me-1"></i> Todas</button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item active" href="#">Todas</a></li>
                                        <li><a class="dropdown-item" href="#">Pendientes</a></li>
                                        <li><a class="dropdown-item" href="#">En Fabricación</a></li>
                                        <li><a class="dropdown-item" href="#">Entregadas</a></li>
                                    </ul>
                                </div>
                                <div class="input-group input-group-sm" style="max-width: 200px;">
                                    <input type="text" class="form-control" id="buscar-solicitud-admin" placeholder="Buscar...">
                                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead><tr><th>ID</th><th>Nota Venta</th><th>Fecha</th><th>Detalle</th><th>Estado</th><th>Observaciones</th><th>Acciones</th></tr></thead>
                                    <tbody id="tabla-solicitudes-admin"></tbody>
                                </table>
                            </div>
                            <div class="card-footer p-2" id="admin-solicitudes-pagination-controls"></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="usuarios-content" role="tabpanel">
                        <div class="card">
                            <div class="card-header"><div class="d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>Gestión de Usuarios</h5><button class="btn btn-sm btn-primary" id="btn-nuevo-usuario"><i class="fas fa-user-plus me-1"></i> Nuevo Usuario</button></div></div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead><tr><th>Usuario</th><th>Nombre</th><th>Rol</th><th>Último Acceso</th><th>Estado</th><th>Acciones</th></tr></thead>
                                    <tbody id="tabla-usuarios"></tbody>
                                </table>
                            </div>
                             <div class="card-footer p-2" id="admin-usuarios-pagination-controls"></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="repuestos-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                            <h5 class="mb-0 me-2">Gestión de Repuestos</h5>
                            <div class="d-flex gap-2 mt-2 mt-md-0">
                                <button class="btn btn-outline-success btn-sm" id="btn-nuevo-repuesto"><i class="fas fa-plus-circle me-1"></i> Nuevo Repuesto</button>
                                <button class="btn btn-outline-primary btn-sm" id="btn-carga-masiva"><i class="fas fa-file-import me-1"></i> Importar Repuestos</button>
                                <button class="btn btn-outline-info btn-sm" id="btn-exportar-repuestos"><i class="fas fa-file-export me-1"></i> Exportar Repuestos</button>
                                <div class="input-group input-group-sm" style="max-width: 200px;">
                                    <input type="text" class="form-control" id="buscar-repuesto" placeholder="Buscar...">
                                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead><tr><th>SKU</th><th>Nombre</th><th>Categoría</th><th>Stock</th><th>Acciones</th></tr></thead>
                                    <tbody id="tabla-repuestos"></tbody>
                                </table>
                            </div>
                            <div class="card-footer p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div id="repuestos-info" class="text-muted small"></div>
                                    <div id="repuestos-pagination"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="dashboard-content" role="tabpanel">
                        <div class="dashboard-header d-flex justify-content-between align-items-center mb-4 flex-wrap">
                            <h5 class="mb-0 me-2"><i class="fas fa-chart-line me-2"></i>Dashboard de Estadísticas</h5>
                            <div class="d-flex gap-2 mt-2 mt-md-0">
                                <select class="form-select form-select-sm" id="time-range-select" style="width: auto;"><option value="7">Últimos 7 días</option><option value="15">Últimos 15 días</option><option value="30" selected>Últimos 30 días</option><option value="90">Últimos 3 meses</option><option value="180">Últimos 6 meses</option><option value="365">Último año</option></select>
                                <button class="btn btn-sm btn-outline-primary" id="btn-actualizar-dashboard"><i class="fas fa-sync-alt me-1"></i> Actualizar</button>
                                <button class="btn btn-sm btn-outline-secondary" id="btn-exportar-dashboard"><i class="fas fa-download me-1"></i> Exportar</button>
                            </div>
                        </div>
                        <div id="dashboard-container" class="mb-4">
                            <div class="row mb-4" id="dashboard-cards"></div>
                            <div id="charts-container"></div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="reportes-content" role="tabpanel">
                        <div class="row">
                            <div class="col-lg-4 mb-4 mb-lg-0">
                                <div class="card sticky-lg-top" style="top: 20px;">
                                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Generar Reporte</h5></div>
                                    <div class="card-body">
                                        <form id="reporte-form">
                                            <div class="mb-3">
                                                <label class="form-label">Tipo de Reporte</label>
                                                <select class="form-select" id="tipo-reporte" required><option value="">-- Seleccionar tipo --</option><option value="solicitudes_por_estado">Solicitudes por Estado</option><option value="tiempo_fabricacion">Tiempo de Fabricación</option><option value="productos_mas_solicitados">Productos más Solicitados</option><option value="actividad_usuarios">Actividad de Usuarios</option><option value="rendimiento_mensual">Rendimiento Mensual</option><option value="reporte_personalizado">Reporte Personalizado</option></select>
                                            </div>
                                            <div id="opciones-reporte" class="mb-3"></div>
                                            <div class="d-grid gap-2"><button type="submit" class="btn btn-primary"><i class="fas fa-file-alt me-1"></i> Generar Reporte</button></div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Resultado del Reporte</h5></div>
                                    <div class="card-body"><div id="reporte-result" class="reporte-container"><div class="text-center p-5 text-muted"><i class="fas fa-file-alt fa-3x mb-3"></i><p>Selecciona un tipo de reporte.</p></div></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="auditoria-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                            <h5 class="mb-0 me-2"><i class="fas fa-history me-2"></i>Registro de Auditoría</h5>
                            <div class="d-flex gap-2 mt-2 mt-md-0">
                                <button class="btn btn-sm btn-outline-primary" id="btn-actualizar-auditoria"><i class="fas fa-sync-alt me-1"></i> Actualizar</button>
                                <button class="btn btn-sm btn-outline-success" id="btn-exportar-auditoria"><i class="fas fa-file-csv me-1"></i> Exportar</button>
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#filtros-auditoria"><i class="fas fa-filter me-1"></i> Filtros</button>
                            </div>
                        </div>
                        <div class="collapse mb-4" id="filtros-auditoria">
                            <div class="card card-body">
                                <form id="form-filtros-auditoria">
                                    <div class="row g-3">
                                        <div class="col-md-6"><label class="form-label">Fecha desde</label><input type="date" class="form-control" name="fecha_desde"></div>
                                        <div class="col-md-6"><label class="form-label">Fecha hasta</label><input type="date" class="form-control" name="fecha_hasta"></div>
                                        <div class="col-md-4"><label class="form-label">Usuario</label><select class="form-select" name="usuario" id="filtro-auditoria-usuario"><option value="">Todos</option></select></div>
                                        <div class="col-md-4"><label class="form-label">Tipo Evento</label><select class="form-select" name="tipo_evento"><option value="">Todos</option><option value="login">Login</option><option value="logout">Logout</option><option value="crear">Crear</option><option value="actualizar">Actualizar</option><option value="eliminar">Eliminar</option><option value="exportar">Exportar</option><option value="ver">Ver</option><option value="error">Error</option></select></div>
                                        <div class="col-md-4"><label class="form-label">Entidad</label><select class="form-select" name="entidad"><option value="">Todas</option><option value="solicitud">Solicitud</option><option value="usuario">Usuario</option><option value="repuesto">Repuesto</option><option value="sistema">Sistema</option><option value="reporte">Reporte</option></select></div>
                                        <div class="col-12 text-end"><button type="reset" class="btn btn-outline-secondary"><i class="fas fa-undo me-1"></i> Limpiar</button><button type="submit" class="btn btn-primary ms-2"><i class="fas fa-search me-1"></i> Filtrar</button></div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="card">
                            <div class="table-responsive"><div id="tabla-auditoria-container"><div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Cargando...</p></div></div></div>
                            <div class="card-footer d-flex justify-content-between align-items-center"><small class="text-muted" id="auditoria-info"></small><button class="btn btn-sm btn-outline-primary" id="btn-cargar-mas-auditoria"><i class="fas fa-plus me-1"></i> Cargar más</button></div>
                        </div>
                    </div>
                </div> </div> </div> </div> <div class="modal fade" id="detalle-modal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Detalle de Solicitud</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="detalle-modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button></div></div></div></div>
    <div class="modal fade" id="actualizar-estado-modal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="fas fa-edit me-2"></i>Actualizar Estado</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="actualizar-estado-form"><input type="hidden" id="solicitud-id"><div class="mb-3"><label for="nuevo-estado" class="form-label">Estado</label><select class="form-select" id="nuevo-estado" required><option value="Solicitud enviada por bodega">Solicitud enviada por bodega</option><option value="En fabricación">En fabricación</option><option value="Entregado">Entregado</option></select></div><div class="mb-3" id="fecha-estimada-container" style="display: none;"><label for="fecha-estimada" class="form-label">Fecha Estimada</label><input type="date" class="form-control" id="fecha-estimada"></div><div class="mb-3" id="fecha-entrega-container" style="display: none;"><label for="fecha-entrega" class="form-label">Fecha Entrega Real</label><input type="date" class="form-control" id="fecha-entrega" readonly></div><div class="mb-3"><label for="observaciones" class="form-label">Observaciones</label><textarea class="form-control" id="observaciones" rows="3"></textarea></div><div class="text-end"><button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Guardar</button></div></form></div></div></div></div>
    <div class="modal fade" id="usuario-modal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="usuario-modal-title"><i class="fas fa-user-plus me-2"></i>Nuevo Usuario</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="usuario-form"><input type="hidden" id="usuario-id"><div class="mb-3"><label for="usuario-username" class="form-label">Usuario</label><input type="text" class="form-control" id="usuario-username" required></div><div class="mb-3"><label for="usuario-displayname" class="form-label">Nombre Completo</label><input type="text" class="form-control" id="usuario-displayname" required></div><div class="mb-3"><label for="usuario-password" class="form-label">Contraseña</label><div class="input-group"><input type="password" class="form-control" id="usuario-password"><button class="btn btn-outline-secondary toggle-password" type="button"><i class="fas fa-eye"></i></button></div></div><div class="mb-3"><label for="usuario-role" class="form-label">Rol</label><select class="form-select" id="usuario-role" required><option value="">-- Seleccionar --</option><option value="bodega">Bodega</option><option value="fabricacion">Fabricación</option><option value="admin">Administrador</option></select></div><div class="mb-3"><label for="usuario-status" class="form-label">Estado</label><select class="form-select" id="usuario-status" required><option value="active">Activo</option><option value="inactive">Inactivo</option></select></div><div class="text-end"><button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Guardar</button></div></form></div></div></div></div>
    <div class="modal fade" id="confirmar-eliminacion-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>¿Seguro deseas eliminar permanentemente esta solicitud?</p><p class="mb-0">Nota de Venta: <strong id="eliminar-nota-venta"></strong></p><p>Esta acción no se puede deshacer.</p><input type="hidden" id="eliminar-solicitud-id"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-danger" id="confirmar-eliminacion-btn"><i class="fas fa-trash-alt me-1"></i>Eliminar</button></div></div></div></div>
    <div class="modal fade" id="detalles-log-modal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Detalles del Registro</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="detalles-log-modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button></div></div></div></div>
    <div class="modal fade" id="repuesto-modal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="repuesto-modal-title"><i class="fas fa-plus-circle me-2"></i>Nuevo Repuesto</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="repuesto-form"><input type="hidden" id="repuesto-id"><div class="mb-3"><label for="repuesto-sku" class="form-label">SKU</label><input type="text" class="form-control" id="repuesto-sku" required></div><div class="mb-3"><label for="repuesto-nombre" class="form-label">Nombre</label><input type="text" class="form-control" id="repuesto-nombre" required></div><div class="mb-3"><label for="repuesto-categoria" class="form-label">Categoría</label><input type="text" class="form-control" id="repuesto-categoria"></div><div class="mb-3"><label for="repuesto-stock" class="form-label">Stock</label><input type="number" class="form-control" id="repuesto-stock" value="0" min="0"></div><div class="text-end"><button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Guardar</button></div></form></div></div></div></div>
    <div class="sync-status" id="sync-status"> <div class="loading-spinner"></div>
        <span id="sync-message">Sincronizando datos...</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/components/modals.js"></script>
    <script src="js/components/ui.js"></script>
    <script src="js/auth.js"></script>

    <script src="js/repuestos.js"></script>
    <script src="js/carga-masiva-repuestos.js"></script>
    <script src="js/carga-masiva-solucion.js"></script>

    <script src="js/bodega-autocomplete.js"></script>
    <script src="js/bodega-repuestos.js"></script>
    <script src="js/bodega.js"></script>
    <script src="js/fabricacion.js"></script>

    <script src="js/admin.js"></script> <script src="js/dashboard.js"></script>
    <script src="js/auditoria.js"></script>   <script src="js/reportes.js"></script>    <script src="js/app.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle de contraseña
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', function() {
                    const inputGroup = this.closest('.input-group');
                    if (!inputGroup) return;
                    const input = inputGroup.querySelector('input[type="password"], input[type="text"]');
                    const icon = this.querySelector('i');
                    if (!input || !icon) return;

                    if (input.type === "password") {
                        input.type = "text";
                        icon.classList.remove("fa-eye");
                        icon.classList.add("fa-eye-slash");
                    } else {
                        input.type = "password";
                        icon.classList.remove("fa-eye-slash");
                        icon.classList.add("fa-eye");
                    }
                });
            });

            // Botón Nuevo Usuario
            const btnNuevoUsuario = document.getElementById('btn-nuevo-usuario');
            if (btnNuevoUsuario) {
                btnNuevoUsuario.addEventListener('click', function() {
                    const usuarioForm = document.getElementById('usuario-form');
                    const usuarioModalTitle = document.getElementById('usuario-modal-title');
                    const usuarioIdInput = document.getElementById('usuario-id');
                    const usuarioPasswordInput = document.getElementById('usuario-password');
                    const usuarioModalEl = document.getElementById('usuario-modal');

                    if (usuarioForm) usuarioForm.reset();
                    if (usuarioIdInput) usuarioIdInput.value = '';
                    if (usuarioModalTitle) usuarioModalTitle.textContent = 'Nuevo Usuario'; // Solo texto
                    if (usuarioPasswordInput) usuarioPasswordInput.required = true;


                    if (usuarioModalEl && typeof bootstrap !== 'undefined') {
                        const modal = bootstrap.Modal.getInstance(usuarioModalEl) || new bootstrap.Modal(usuarioModalEl);
                        modal.show();
                    }
                });
            }
            
            // Inicializar módulos que exponen 'init' en window
            // (Es mejor que app.js maneje estas inicializaciones para asegurar dependencias)
            if (window.dashboard && typeof window.dashboard.init === 'function') window.dashboard.init();
            else if (typeof initDashboard === 'function') initDashboard();

            if (window.auditoria && typeof window.auditoria.init === 'function') window.auditoria.init();
            else if (typeof initAuditoria === 'function') initAuditoria();

            if (window.reportes && typeof window.reportes.init === 'function') window.reportes.init();
            else if (typeof initReportes === 'function') initReportes();


            // Event listeners para botones que llaman funciones de módulos
            const setupButtonListener = (buttonId, module, functionName, ...args) => {
                const button = document.getElementById(buttonId);
                if (button && module && typeof module[functionName] === 'function') {
                    button.addEventListener('click', () => module[functionName](...args));
                } else if (button && typeof window[functionName] === 'function') { // Fallback a función global
                     button.addEventListener('click', () => window[functionName](...args));
                }
            };

            // Dashboard
            setupButtonListener('btn-actualizar-dashboard', window.dashboard, 'cargarEstadisticas');
            setupButtonListener('btn-exportar-dashboard', window.dashboard, 'exportarDashboard');

            // Auditoría
            setupButtonListener('btn-actualizar-auditoria', window.auditoria, 'cargarRegistrosAuditoria');
            setupButtonListener('btn-exportar-auditoria', window.auditoria, 'exportarLogsAuditoriaConCarga'); // Necesitarás una función wrapper
            setupButtonListener('btn-cargar-mas-auditoria', window.auditoria, 'cargarMasRegistros'); // Asumiendo que existe en window.auditoria

            const formFiltrosAuditoria = document.getElementById('form-filtros-auditoria');
            if (formFiltrosAuditoria && window.auditoria && typeof window.auditoria.aplicarFiltrosDesdeForm === 'function') {
                formFiltrosAuditoria.addEventListener('submit', (e) => {
                    e.preventDefault();
                    window.auditoria.aplicarFiltrosDesdeForm(formFiltrosAuditoria);
                });
                const btnLimpiarFiltrosAuditoria = formFiltrosAuditoria.querySelector('button[type="reset"]');
                if(btnLimpiarFiltrosAuditoria){
                    btnLimpiarFiltrosAuditoria.addEventListener('click', () => {
                        // El reset limpia el form, luego aplicar filtros con form vacío
                        setTimeout(() => window.auditoria.aplicarFiltrosDesdeForm(formFiltrosAuditoria), 0);
                    });
                }
            }

            // Cargar contenido de pestañas de Admin al activarlas
            document.querySelectorAll('#adminTabs .nav-link').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (event) {
                    const targetTabId = event.target.getAttribute('data-bs-target');
                    console.log(`INDEX.HTML: Pestaña admin cambiada a: ${targetTabId}`);
                    if (targetTabId === '#auditoria-content' && window.auditoria && typeof window.auditoria.cargarRegistrosAuditoria === 'function') {
                        window.auditoria.cargarRegistrosAuditoria();
                    } else if (targetTabId === '#dashboard-content' && window.dashboard && typeof window.dashboard.cargarEstadisticas === 'function') {
                        window.dashboard.cargarEstadisticas();
                    }
                    // Añadir lógica para otras pestañas si es necesario
                });
            });
            
            // Cargar contenido de la pestaña activa inicialmente
            const activeAdminTab = document.querySelector('#adminTabs .nav-link.active');
            if (activeAdminTab) {
                const activeTabId = activeAdminTab.getAttribute('data-bs-target');
                 if (activeTabId === '#auditoria-content' && window.auditoria && typeof window.auditoria.cargarRegistrosAuditoria === 'function') {
                     window.auditoria.cargarRegistrosAuditoria();
                 } else if (activeTabId === '#dashboard-content' && window.dashboard && typeof window.dashboard.cargarEstadisticas === 'function') {
                     window.dashboard.cargarEstadisticas();
                 }
            }
        });
    </script>
</body>
</html>

